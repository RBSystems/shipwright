<div class="mat-elevation-z3 container">
    <section class="severity">
        <button mat-flat-button class="button all">All Alerts</button>
        <button mat-flat-button class="button critical">Critical</button>
        <button mat-flat-button class="button warning">Warning</button>
    </section>
    <section>
        <mat-form-field>
            <mat-label>Filters</mat-label>
            <mat-chip-list #filterChips>
                <mat-chip *ngFor="let filter of filters" [selectable]="true" [removable]="true" (removed)="text.RemoveFilter(filter, filters); ApplyFilters()">
                    {{filter}}
                    <mat-icon matChipRemove>cancel</mat-icon>
                </mat-chip>
                <input matInput type="text" [matChipInputFor]="filterChips" [matChipInputSeparatorKeyCodes]="text.separatorKeyCodes" [matChipInputAddOnBlur]="true" (matChipInputTokenEnd)="text.AddFilter($event, filters); ApplyFilters()">
            </mat-chip-list>
        </mat-form-field>
    </section>
    <table mat-table [dataSource]="issueData" matSort multiTemplateDataRows class="mat-elevation-z0">
        <ng-container matColumnDef="icon">
            <th mat-header-cell *matHeaderCellDef> System Type </th>
            <td mat-cell *matCellDef="let issue" (click)="ExpandRow(issue)">
                <mat-icon>{{text.SystemTypeIcon[issue.systemType]}}</mat-icon>
            </td>
        </ng-container>

        <ng-container matColumnDef="roomID">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Room ID </th>
            <td mat-cell *matCellDef="let issue" (click)="ExpandRow(issue)">
                <div routerLink="/configuration/{{issue.roomID}}/roompage" class="fake-hyperlink">
                    {{issue.roomID}}
                </div>
            </td>
        </ng-container>

        <ng-container matColumnDef="severity">
            <th mat-header-cell *matHeaderCellDef> Severity </th>
            <td mat-cell *matCellDef="let issue">
                <span [ngClass]="issue.severity + '-severity'" (click)="ExpandRow(issue)">{{text.Title(issue.severity)}}</span>
            </td>
        </ng-container>

        <ng-container matColumnDef="count">
            <th mat-header-cell *matHeaderCellDef class="centered"> Active/Total </th>
            <td mat-cell *matCellDef="let issue" (click)="ExpandRow(issue)" class="centered">{{issue.activeAlertCount}}/{{issue.alertCount}}</td>
        </ng-container>

        <ng-container matColumnDef="types">
            <th mat-header-cell *matHeaderCellDef> Alert Types </th>
            <td mat-cell *matCellDef="let issue" (click)="ExpandRow(issue)">{{issue.activeAlertTypes?.length > charCount ? (ArrayToString(issue.activeAlertTypes) | slice:0:charCount)+".." : ArrayToString(issue.activeAlertTypes)}}</td>
        </ng-container>

        <ng-container matColumnDef="incident">
            <th mat-header-cell *matHeaderCellDef> Incident ID </th>
            <td mat-cell *matCellDef="let issue">
                <div (click)="ServiceNowRedirect(issue.incidentID)" class="fake-hyperlink">
                    {{issue.incidentID}}
                </div>
            </td>
        </ng-container>

        <ng-container matColumnDef="help-sent">
            <th mat-header-cell *matHeaderCellDef class="centered"> Help Sent </th>
            <td mat-cell *matCellDef="let issue" (click)="ExpandRow(issue)" class="centered">
                <mat-icon *ngIf="issue.SentIsZero()" class="bad-status">cancel</mat-icon>
                <mat-icon *ngIf="!issue.SentIsZero()" class="good-status">check_circle</mat-icon>
            </td>
        </ng-container>

        <ng-container matColumnDef="help-arrived">
            <th mat-header-cell *matHeaderCellDef class="centered"> Help Arrived </th>
            <td mat-cell *matCellDef="let issue" (click)="ExpandRow(issue)" class="centered">
                <mat-icon *ngIf="issue.ArrivedIsZero()" class="bad-status">cancel</mat-icon>
                <mat-icon *ngIf="!issue.ArrivedIsZero()" class="good-status">check_circle</mat-icon>
            </td>
        </ng-container>

        <ng-container matColumnDef="responders">
            <th mat-header-cell *matHeaderCellDef> Responders </th>
            <td mat-cell *matCellDef="let issue" (click)="ExpandRow(issue)">
                {{ArrayToString(issue.responders)}}
            </td>
        </ng-container>

        <ng-container matColumnDef="expandedDetail">
            <td mat-cell *matCellDef="let issue" [attr.colspan]="issueColumns.length">
                <div class="alert-detail" [@detailExpand]="expIssue === issue ? 'expanded' : 'collapsed'">
                    <table mat-table [dataSource]="issue.alerts" class="mat-elevation-z0">

                        <ng-container matColumnDef="select">

                            <th mat-header-cell *matHeaderCellDef>
                                <ng-container *ngIf="singleRoom">
                                    <mat-checkbox color="warn" (change)="$event ? MasterToggle() : null" [checked]="selection.hasValue() && IsAllSelected()" [indeterminate]="selection.hasValue() && !IsAllSelected()"></mat-checkbox>
                                </ng-container>
                            </th>
                            <td mat-cell *matCellDef="let alert">
                                <ng-container *ngIf="singleRoom">
                                    <mat-checkbox color="warn" (click)="$event.stopPropagation()" (change)="$event ? selection.toggle(alert) : null" [checked]="selection.isSelected(alert)"></mat-checkbox>
                                </ng-container>
                            </td>

                        </ng-container>


                        <ng-container matColumnDef="name">
                            <th mat-header-cell *matHeaderCellDef> Device Name </th>
                            <td mat-cell *matCellDef="let alert">{{GetDeviceName(alert.deviceID)}}</td>
                        </ng-container>

                        <ng-container matColumnDef="type">
                            <th mat-header-cell *matHeaderCellDef> Type </th>
                            <td mat-cell *matCellDef="let alert">{{text.Title(alert.type)}}</td>
                        </ng-container>

                        <ng-container matColumnDef="category">
                            <th mat-header-cell *matHeaderCellDef> Category </th>
                            <td mat-cell *matCellDef="let alert">{{text.Title(alert.category)}}</td>
                        </ng-container>

                        <ng-container matColumnDef="message">
                            <th mat-header-cell *matHeaderCellDef> Message </th>
                            <td mat-cell *matCellDef="let alert">{{alert.message}}</td>
                        </ng-container>

                        <ng-container matColumnDef="start-time">
                            <th mat-header-cell *matHeaderCellDef> Start Time </th>
                            <td mat-cell *matCellDef="let alert">
                                <!-- <ng-container *ngIf="!TimeIsZero(alert.startTime)">
                                    {{GetReadableTimestamp(alert.startTime)}}
                                </ng-container>
                                <ng-container *ngIf="TimeIsZero(alert.startTime)">
                                    --
                                </ng-container> -->
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="end-time">
                            <th mat-header-cell *matHeaderCellDef> End Time </th>
                            <td mat-cell *matCellDef="let alert">
                                <!-- <ng-container *ngIf="!TimeIsZero(alert.endTime) && !alert.active">
                                    {{GetReadableTimestamp(alert.endTime)}}
                                </ng-container>
                                <ng-container *ngIf="TimeIsZero(alert.endTime)">
                                    --
                                </ng-container> -->
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="alertColumns"></tr>
                        <tr mat-row *matRowDef="let alert; columns: alertColumns;" (click)="selection.toggle(alert)" [class.inactive-alert]="!alert.active"></tr>
                    </table>
                </div>
            </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="issueColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let issue; columns: issueColumns;" [class.example-expanded-row]="expIssue === issue"></tr>
        <tr mat-row *matRowDef="let issue; columns: ['expandedDetail']" class="alert-detail-row"></tr>
    </table>
    <mat-paginator [pageSizeOptions]="[5, 10, 25, 50, 100]" [pageSize]="25"></mat-paginator>
</div>